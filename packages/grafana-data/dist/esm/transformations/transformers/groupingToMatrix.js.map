{"version":3,"file":"groupingToMatrix.js","sources":["../../../../src/transformations/transformers/groupingToMatrix.ts"],"sourcesContent":["import { map } from 'rxjs/operators';\n\nimport { getFieldDisplayName } from '../../field/fieldState';\nimport {\n  DataFrame,\n  DataTransformerInfo,\n  Field,\n  FieldType,\n  SpecialValue,\n  TransformationApplicabilityLevels,\n} from '../../types';\nimport { fieldMatchers } from '../matchers';\nimport { FieldMatcherID } from '../matchers/ids';\n\nimport { DataTransformerID } from './ids';\n\nexport interface GroupingToMatrixTransformerOptions {\n  columnField?: string;\n  rowField?: string;\n  valueField?: string;\n  emptyValue?: SpecialValue;\n}\n\nconst DEFAULT_COLUMN_FIELD = 'Time';\nconst DEFAULT_ROW_FIELD = 'Time';\nconst DEFAULT_VALUE_FIELD = 'Value';\nconst DEFAULT_EMPTY_VALUE = SpecialValue.Empty;\n\n// grafana-data does not have access to runtime so we are accessing the window object\n// to get access to the feature toggle\n// eslint-disable-next-line\nconst supportDataplaneFallback = (window as any)?.grafanaBootData?.settings?.featureToggles?.dataplaneFrontendFallback;\n\nexport const groupingToMatrixTransformer: DataTransformerInfo<GroupingToMatrixTransformerOptions> = {\n  id: DataTransformerID.groupingToMatrix,\n  name: 'Grouping to Matrix',\n  description: 'Groups series by field and return a matrix visualisation',\n  defaultOptions: {\n    columnField: DEFAULT_COLUMN_FIELD,\n    rowField: DEFAULT_ROW_FIELD,\n    valueField: DEFAULT_VALUE_FIELD,\n  },\n  /**\n   * Grouping to matrix requires at least 3 fields to work.\n   */\n  isApplicable: (data: DataFrame[]) => {\n    let numFields = 0;\n\n    for (const frame of data) {\n      numFields += frame.fields.length;\n    }\n\n    return numFields >= 3\n      ? TransformationApplicabilityLevels.Applicable\n      : TransformationApplicabilityLevels.NotApplicable;\n  },\n  isApplicableDescription: (data: DataFrame[]) => {\n    let numFields = 0;\n\n    for (const frame of data) {\n      numFields += frame.fields.length;\n    }\n\n    return `Grouping to matrix requiers at least 3 fields to work. Currently there are ${numFields} fields.`;\n  },\n  operator: (options) => (source) =>\n    source.pipe(\n      map((data) => {\n        const columnFieldMatch = options.columnField || DEFAULT_COLUMN_FIELD;\n        const rowFieldMatch = options.rowField || DEFAULT_ROW_FIELD;\n        const valueFieldMatch = options.valueField || DEFAULT_VALUE_FIELD;\n        const emptyValue = options.emptyValue || DEFAULT_EMPTY_VALUE;\n\n        // Accept only single queries\n        if (data.length !== 1) {\n          return data;\n        }\n\n        const frame = data[0];\n        const keyColumnField = findKeyField(frame, columnFieldMatch);\n        const keyRowField = findKeyField(frame, rowFieldMatch);\n        const valueField = findKeyField(frame, valueFieldMatch);\n        const rowColumnField = `${rowFieldMatch}\\\\${columnFieldMatch}`;\n\n        if (!keyColumnField || !keyRowField || !valueField) {\n          return data;\n        }\n\n        const columnValues = uniqueValues(keyColumnField.values);\n        const rowValues = uniqueValues(keyRowField.values);\n\n        const matrixValues: { [key: string]: { [key: string]: unknown } } = {};\n\n        for (let index = 0; index < valueField.values.length; index++) {\n          const columnName = keyColumnField.values[index];\n          const rowName = keyRowField.values[index];\n          const value = valueField.values[index];\n\n          if (!matrixValues[columnName]) {\n            matrixValues[columnName] = {};\n          }\n\n          matrixValues[columnName][rowName] = value;\n        }\n\n        const fields: Field[] = [\n          {\n            name: rowColumnField,\n            values: rowValues,\n            type: FieldType.string,\n            config: {},\n          },\n        ];\n\n        for (const columnName of columnValues) {\n          let values = [];\n          for (const rowName of rowValues) {\n            const value = matrixValues[columnName][rowName] ?? getSpecialValue(emptyValue);\n            values.push(value);\n          }\n\n          // setting the displayNameFromDS in prometheus overrides\n          // the column name based on value fields that are numbers\n          // this prevents columns that should be named 1000190\n          // from becoming named {__name__: 'metricName'}\n          if (supportDataplaneFallback && typeof columnName === 'number') {\n            valueField.config = { ...valueField.config, displayNameFromDS: undefined };\n          }\n\n          fields.push({\n            name: columnName.toString(),\n            values: values,\n            config: valueField.config,\n            type: valueField.type,\n          });\n        }\n\n        return [\n          {\n            fields,\n            length: rowValues.length,\n          },\n        ];\n      })\n    ),\n};\n\nfunction uniqueValues<T>(values: T[]): T[] {\n  const unique = new Set<T>();\n\n  for (let index = 0; index < values.length; index++) {\n    unique.add(values[index]);\n  }\n\n  return Array.from(unique);\n}\n\nfunction findKeyField(frame: DataFrame, matchTitle: string): Field | null {\n  for (let fieldIndex = 0; fieldIndex < frame.fields.length; fieldIndex++) {\n    const field = frame.fields[fieldIndex];\n\n    // support for dataplane contract with Prometheus and change in location of field name\n    let matches: boolean;\n    if (supportDataplaneFallback) {\n      const matcher = fieldMatchers.get(FieldMatcherID.byName).get(matchTitle);\n      matches = matcher(field, frame, [frame]);\n    } else {\n      matches = matchTitle === getFieldDisplayName(field);\n    }\n\n    if (matches) {\n      return field;\n    }\n  }\n\n  return null;\n}\n\nfunction getSpecialValue(specialValue: SpecialValue) {\n  switch (specialValue) {\n    case SpecialValue.False:\n      return false;\n    case SpecialValue.True:\n      return true;\n    case SpecialValue.Null:\n      return null;\n    case SpecialValue.Empty:\n    default:\n      return '';\n  }\n}\n"],"names":["_a"],"mappings":"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"}