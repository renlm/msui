{"version":3,"file":"LabelFilterItem.js","sources":["../../../../src/querybuilder/components/LabelFilterItem.tsx"],"sourcesContent":["// Core Grafana history https://github.com/grafana/grafana/blob/v11.0.0-preview/public/app/plugins/datasource/prometheus/querybuilder/components/LabelFilterItem.tsx\nimport debounce from 'debounce-promise';\nimport React, { useState } from 'react';\n\nimport { SelectableValue, toOption } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { AccessoryButton, InputGroup } from '@grafana/experimental';\nimport { AsyncSelect, Select } from '@grafana/ui';\n\nimport { truncateResult } from '../../language_utils';\nimport { QueryBuilderLabelFilter } from '../shared/types';\n\nexport interface LabelFilterItemProps {\n  defaultOp: string;\n  item: Partial<QueryBuilderLabelFilter>;\n  onChange: (value: QueryBuilderLabelFilter) => void;\n  onGetLabelNames: (forLabel: Partial<QueryBuilderLabelFilter>) => Promise<SelectableValue[]>;\n  onGetLabelValues: (forLabel: Partial<QueryBuilderLabelFilter>) => Promise<SelectableValue[]>;\n  onDelete: () => void;\n  invalidLabel?: boolean;\n  invalidValue?: boolean;\n  getLabelValuesAutofillSuggestions: (query: string, labelName?: string) => Promise<SelectableValue[]>;\n  debounceDuration: number;\n}\n\nexport function LabelFilterItem({\n  item,\n  defaultOp,\n  onChange,\n  onDelete,\n  onGetLabelNames,\n  onGetLabelValues,\n  invalidLabel,\n  invalidValue,\n  getLabelValuesAutofillSuggestions,\n  debounceDuration,\n}: LabelFilterItemProps) {\n  const [state, setState] = useState<{\n    labelNames?: SelectableValue[];\n    labelValues?: SelectableValue[];\n    isLoadingLabelNames?: boolean;\n    isLoadingLabelValues?: boolean;\n  }>({});\n  // there's a bug in react-select where the menu doesn't recalculate its position when the options are loaded asynchronously\n  // see https://github.com/grafana/grafana/issues/63558\n  // instead, we explicitly control the menu visibility and prevent showing it until the options have fully loaded\n  const [labelNamesMenuOpen, setLabelNamesMenuOpen] = useState(false);\n  const [labelValuesMenuOpen, setLabelValuesMenuOpen] = useState(false);\n\n  const isMultiSelect = (operator = item.op) => {\n    return operators.find((op) => op.label === operator)?.isMultiValue;\n  };\n\n  const getSelectOptionsFromString = (item?: string): string[] => {\n    if (item) {\n      const regExp = /\\(([^)]+)\\)/;\n      const matches = item?.match(regExp);\n\n      if (matches && matches[0].indexOf('|') > 0) {\n        return [item];\n      }\n\n      if (item.indexOf('|') > 0) {\n        return item.split('|');\n      }\n      return [item];\n    }\n    return [];\n  };\n\n  const labelValueSearch = debounce(\n    (query: string) => getLabelValuesAutofillSuggestions(query, item.label),\n    debounceDuration\n  );\n\n  const itemValue = item?.value ?? '';\n\n  return (\n    <div key={itemValue} data-testid=\"prometheus-dimensions-filter-item\">\n      <InputGroup>\n        {/* Label name select, loads all values at once */}\n        <Select\n          placeholder=\"Select label\"\n          data-testid={selectors.components.QueryBuilder.labelSelect}\n          inputId=\"prometheus-dimensions-filter-item-key\"\n          width=\"auto\"\n          value={item.label ? toOption(item.label) : null}\n          allowCustomValue\n          onOpenMenu={async () => {\n            setState({ isLoadingLabelNames: true });\n            const labelNames = await onGetLabelNames(item);\n            setLabelNamesMenuOpen(true);\n            setState({ labelNames, isLoadingLabelNames: undefined });\n          }}\n          onCloseMenu={() => {\n            setLabelNamesMenuOpen(false);\n          }}\n          isOpen={labelNamesMenuOpen}\n          isLoading={state.isLoadingLabelNames ?? false}\n          options={state.labelNames}\n          onChange={(change) => {\n            if (change.label) {\n              onChange({\n                ...item,\n                op: item.op ?? defaultOp,\n                label: change.label,\n                // eslint-ignore\n              } as QueryBuilderLabelFilter);\n            }\n          }}\n          invalid={invalidLabel}\n        />\n\n        {/* Operator select i.e.   = =~ != !~   */}\n        <Select\n          data-testid={selectors.components.QueryBuilder.matchOperatorSelect}\n          className=\"query-segment-operator\"\n          value={toOption(item.op ?? defaultOp)}\n          options={operators}\n          width=\"auto\"\n          onChange={(change) => {\n            if (change.value != null) {\n              onChange({\n                ...item,\n                op: change.value,\n                value: isMultiSelect(change.value) ? item.value : getSelectOptionsFromString(item?.value)[0],\n                // eslint-ignore\n              } as QueryBuilderLabelFilter);\n            }\n          }}\n        />\n\n        {/* Label value async select: autocomplete calls prometheus API */}\n        <AsyncSelect\n          placeholder=\"Select value\"\n          data-testid={selectors.components.QueryBuilder.valueSelect}\n          inputId=\"prometheus-dimensions-filter-item-value\"\n          width=\"auto\"\n          value={\n            isMultiSelect()\n              ? getSelectOptionsFromString(itemValue).map(toOption)\n              : getSelectOptionsFromString(itemValue).map(toOption)[0]\n          }\n          allowCustomValue\n          formatCreateLabel={(input) => input} // to avoid confusion, opt out of using the `defaultFormatCreateLabel`\n          createOptionPosition={item.op?.includes('~') ? 'first' : 'last'}\n          onOpenMenu={async () => {\n            setState({ isLoadingLabelValues: true });\n            const labelValues = await onGetLabelValues(item);\n            truncateResult(labelValues);\n            setLabelValuesMenuOpen(true);\n            setState({\n              ...state,\n              labelValues,\n              isLoadingLabelValues: undefined,\n            });\n          }}\n          onCloseMenu={() => {\n            setLabelValuesMenuOpen(false);\n          }}\n          isOpen={labelValuesMenuOpen}\n          defaultOptions={state.labelValues}\n          isMulti={isMultiSelect()}\n          isLoading={state.isLoadingLabelValues}\n          loadOptions={labelValueSearch}\n          onChange={(change) => {\n            if (change.value) {\n              onChange({\n                ...item,\n                value: change.value,\n                op: item.op ?? defaultOp,\n                // eslint-ignore\n              } as QueryBuilderLabelFilter);\n            } else {\n              const changes = change\n                .map((change: { label?: string }) => {\n                  return change.label;\n                })\n                .join('|');\n              // eslint-ignore\n              onChange({ ...item, value: changes, op: item.op ?? defaultOp } as QueryBuilderLabelFilter);\n            }\n          }}\n          invalid={invalidValue}\n        />\n        <AccessoryButton aria-label={`remove-${item.label}`} icon=\"times\" variant=\"secondary\" onClick={onDelete} />\n      </InputGroup>\n    </div>\n  );\n}\n\nconst operators = [\n  { label: '=', value: '=', isMultiValue: false },\n  { label: '!=', value: '!=', isMultiValue: false },\n  { label: '=~', value: '=~', isMultiValue: true },\n  { label: '!~', value: '!~', isMultiValue: true },\n];\n"],"names":["_a","item","_b","change"],"mappings":"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"}