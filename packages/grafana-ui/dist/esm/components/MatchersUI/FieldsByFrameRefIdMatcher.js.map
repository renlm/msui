{"version":3,"file":"FieldsByFrameRefIdMatcher.js","sources":["../../../../src/components/MatchersUI/FieldsByFrameRefIdMatcher.tsx"],"sourcesContent":["import React, { useMemo, useState, useCallback } from 'react';\n\nimport { DataFrame, getFrameDisplayName, FieldMatcherID, fieldMatchers, SelectableValue } from '@grafana/data';\n\nimport { Select } from '../Select/Select';\n\nimport { FieldMatcherUIRegistryItem, MatcherUIProps } from './types';\n\nconst recoverRefIdMissing = (\n  newRefIds: SelectableValue[],\n  oldRefIds: SelectableValue[],\n  previousValue: string | undefined\n): SelectableValue | undefined => {\n  if (!previousValue) {\n    return;\n  }\n  // Previously selected value is missing from the new list.\n  // Find the value that is in the new list but isn't in the old list\n  let changedTo = newRefIds.find((refId) => {\n    return !oldRefIds.some((refId2) => {\n      return refId === refId2;\n    });\n  });\n  if (changedTo) {\n    // Found the new value, we assume the old value changed to this one, so we'll use it\n    return changedTo;\n  }\n  return;\n};\n\nexport interface Props {\n  value?: string; // refID\n  data: DataFrame[];\n  onChange: (value: string) => void;\n  placeholder?: string;\n}\n\n// Not exported globally... but used in grafana core\nexport function RefIDPicker({ value, data, onChange, placeholder }: Props) {\n  const listOfRefIds = useMemo(() => getListOfQueryRefIds(data), [data]);\n\n  const [priorSelectionState, updatePriorSelectionState] = useState<{\n    refIds: SelectableValue[];\n    value: string | undefined;\n  }>({\n    refIds: [],\n    value: undefined,\n  });\n\n  const currentValue = useMemo(() => {\n    return (\n      listOfRefIds.find((refId) => refId.value === value) ??\n      recoverRefIdMissing(listOfRefIds, priorSelectionState.refIds, priorSelectionState.value)\n    );\n  }, [value, listOfRefIds, priorSelectionState]);\n\n  const onFilterChange = useCallback(\n    (v: SelectableValue<string>) => {\n      onChange(v?.value!);\n    },\n    [onChange]\n  );\n\n  if (listOfRefIds !== priorSelectionState.refIds || currentValue?.value !== priorSelectionState.value) {\n    updatePriorSelectionState({\n      refIds: listOfRefIds,\n      value: currentValue?.value,\n    });\n  }\n  return (\n    <Select\n      options={listOfRefIds}\n      onChange={onFilterChange}\n      isClearable={true}\n      placeholder={placeholder ?? 'Select query refId'}\n      value={currentValue}\n    />\n  );\n}\n\nfunction getListOfQueryRefIds(data: DataFrame[]): Array<SelectableValue<string>> {\n  const queries = new Map<string, DataFrame[]>();\n\n  for (const frame of data) {\n    const refId = frame.refId ?? '';\n    const frames = queries.get(refId) ?? [];\n\n    if (frames.length === 0) {\n      queries.set(refId, frames);\n    }\n\n    frames.push(frame);\n  }\n\n  const values: Array<SelectableValue<string>> = [];\n\n  for (const [refId, frames] of queries.entries()) {\n    values.push({\n      value: refId,\n      label: `Query: ${refId ?? '(missing refId)'}`,\n      description: getFramesDescription(frames),\n    });\n  }\n\n  return values;\n}\n\nfunction getFramesDescription(frames: DataFrame[]): string {\n  return `Frames (${frames.length}):\n    ${frames\n      .slice(0, Math.min(3, frames.length))\n      .map((x) => getFrameDisplayName(x))\n      .join(', ')} ${frames.length > 3 ? '...' : ''}`;\n}\n\n/**\n * Registry item for UI to configure \"fields by frame refId\"-matcher.\n * @public\n */\nexport const fieldsByFrameRefIdItem: FieldMatcherUIRegistryItem<string> = {\n  id: FieldMatcherID.byFrameRefID,\n  component: (props: MatcherUIProps<string>) => {\n    return <RefIDPicker value={props.options} data={props.data} onChange={props.onChange} />;\n  },\n  matcher: fieldMatchers.get(FieldMatcherID.byFrameRefID),\n  name: 'Fields returned by query',\n  description: 'Set properties for fields from a specific query',\n  optionsToLabel: (options) => options,\n};\n"],"names":["React"],"mappings":"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"}